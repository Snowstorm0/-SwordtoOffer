<!-- GFM-TOC -->

* [编译系统](#编译系统)
* [静态链接](#静态链接)
* [目标文件](#目标文件)
* [动态链接](#动态链接)
* [软链接和硬链接](#软链接和硬链接)

<!-- GFM-TOC -->

# 编译系统

以下是一个 hello.c 程序：

```c
#include <stdio.h>
int main()
{
    printf("hello, world\n");
    return 0;
}
```

在 Unix 系统上，由编译器把源文件转换为目标文件。

```bash
gcc -o hello hello.c
```

这个过程大致如下：

对于 C++源文件，从文本到可执行文件一般需要四个过程：

1. **预处理**阶段：对源代码文件中文件包含关系（头文件）、预编译语句（宏定义）进行分析和替换，生成**预编译文件**(.i)；
2. **编译**阶段：将经过预处理后的预编译文件转换成特定**汇编代码**，生成**汇编文件**(.s) 。
3. **汇编**阶段：将编译阶段生成的汇编文件转化成**机器码**，生成**可重定位目标文件**(.o)；
4. **链接**阶段：将多个**目标文件**及所需要的**库**连接成最终的**可执行目标文件**(.out)。

<img src="E:/0OneDrive/OneDrive/Work/CSNote/0other/0/pics/编译过程.jpg" width="600px" />

源代码(.cpp) => 预处理(g++ -E -o) => 预编译文件(.i) => 编译器(g++ -S) => 汇编程序(.s) => 汇编器(as) => 可重定位目标程序(.o) => 链接器(1d) => 可执行目标程序(.out)

命令：

1. 预处理：g++ -E hello.cpp -o hello.i
2. 编译：g++ -S hello.i -o hello.s  // 运行到.s
3. 运行 g++ -C hello.cpp  // 直接运行到.o 





# 静态链接

静态链接器以一组可重定位目标文件为输入，生成一个完全链接的可执行目标文件作为输出。链接器主要完成以下两个任务：

- 符号解析：每个符号对应于一个函数、一个全局变量或一个静态变量，符号解析的目的是将每个符号引用与一个符号定义关联起来。
- 重定位：链接器通过把每个符号定义与一个内存位置关联起来，然后修改所有对这些符号的引用，使得它们指向这个内存位置。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/47d98583-8bb0-45cc-812d-47eefa0a4a40.jpg"/> </div><br>

# 目标文件

- 可执行目标文件：可以直接在内存中执行；
- 可重定位目标文件：可与其它可重定位目标文件在链接阶段合并，创建一个可执行目标文件；
- 共享目标文件：这是一种特殊的可重定位目标文件，可以在运行时被动态加载进内存并链接；

# 动态链接

静态库有以下两个问题：

- 当静态库更新时那么整个程序都要重新进行链接；
- 对于 printf 这种标准函数库，如果每个程序都要有代码，这会极大浪费资源。

共享库是为了解决静态库的这两个问题而设计的，在 Linux 系统中通常用 .so 后缀来表示，Windows 系统上它们被称为 DLL。它具有以下特点：

- 在给定的文件系统中**一个库只有一个文件**，所有引用该库的可执行目标文件都共享这个文件，它不会被复制到引用它的可执行文件中；
- 在内存中，一个共享库的 .text 节（已编译程序的机器代码）的一个副本可以被不同的正在运行的进程共享。

<div align="center"> <img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/76dc7769-1aac-4888-9bea-064f1caa8e77.jpg"/> </div><br>

# 软链接和硬链接

为了解决文件共享问题，Linux 引入了软链接和硬链接。除了为 Linux 解决文件共享使用，还带来了隐藏文件路径、增加权限安全及节省存储等好处。

若 1 个 inode 号对应多个文件名，则为硬链接，即硬链接就是同一个文件使用了不同的**别名**，使用 `ln` 创建。

若文件用户数据块中存放的内容是另一个文件的路径名指向，则该文件是软连接。软连接是一个**普通文件**，有自己独立的inode，但是其数据块内容比较特殊。使用 `ln -s` 创建。













